<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sherbrooke East ‚Äî Renovations (Single‚ÄëFile)</title>
  <meta name="theme-color" content="#0E1114" />
  <style>
    :root{--bg:#0E1114;--fg:#F5F2EC;--muted:#C5A35A;--line:#243141;--soft:rgba(255,255,255,.06)}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header,footer{position:sticky;z-index:10;background:rgba(14,17,20,.9);backdrop-filter:blur(8px)}
    header{top:0;border-bottom:1px solid #ffffff1a}
    footer{bottom:0;border-top:1px solid #ffffff1a}
    .wrap{max-width:880px;margin:0 auto;padding:12px 16px}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}
    .badge{background:var(--soft);border:1px solid #ffffff1a;border-radius:999px;padding:4px 10px;font-size:12px}
    input[type="text"], textarea{width:100%;background:#0E1114;color:var(--fg);border:1px solid #ffffff1a;border-radius:12px;padding:10px 12px;outline:none}
    input::placeholder, textarea::placeholder{color:#ffffff80}
    button,.btn{background:var(--soft);border:1px solid #ffffff1a;color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn-gold{background:var(--muted);border-color:var(--muted);color:#0E1114}
    .grid{display:grid;gap:12px}
    .card{border:1px solid #ffffff1a;background:rgba(255,255,255,.03);border-radius:18px}
    .card-h{display:flex;justify-content:space-between;align-items:center;padding:14px 16px}
    .pill{display:inline-flex;gap:6px}
    .pill button{font-size:12px;padding:6px 10px;border-radius:999px}
    .pill .active{background:var(--muted);color:#0E1114;border-color:var(--muted)}
    details{border-top:1px solid #ffffff12}
    summary{cursor:pointer;list-style:none;padding:14px 16px}
    summary::-webkit-details-marker{display:none}
    .sec{padding:0 16px 16px 16px}
    .checks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .checks label{display:flex;gap:8px;align-items:center;font-size:14px}
    .photos{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .thumb{position:relative;border:1px solid #ffffff1a;border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:120px;object-fit:cover;display:block}
    .x{position:absolute;right:6px;top:6px;background:#0E1114cc;border:1px solid #ffffff55;border-radius:999px;padding:2px 7px;font-size:12px}
    .muted{color:#ffffff99;font-size:13px}
    .progress{height:8px;border-radius:999px;background:#ffffff12;overflow:hidden}
    .bar{height:100%;background:var(--muted);width:0%}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media (max-width:520px){.checks{grid-template-columns:1fr}.photos{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
  <header>
    <div class="wrap grid" style="gap:10px">
      <div class="row">
        <div style="width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,#C5A35A,#9BA3AE)"></div>
        <h1 style="font-family:'Playfair Display',serif;font-size:18px;margin:0">Sherbrooke East ‚Äî Renovations</h1>
        <div class="grow"></div>
        <button id="btnExport" class="btn">Export JSON</button>
        <button id="btnClear" class="btn">Clear</button>
      </div>
      <div class="row">
        <input id="q" type="text" placeholder="Search by room # or notes‚Ä¶" class="grow" />
        <span class="badge" id="stats">0 shown ‚Ä¢ 0/23 done ‚Ä¢ 0 photos</span>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>
  </header>

  <main class="wrap" style="padding-bottom:92px">
    <div id="list" class="grid"></div>
  </main>

  <footer>
    <div class="wrap row">
      <button id="btnExportAll" class="btn btn-gold">Export All PDFs</button>
      <button id="btnImport" class="btn">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <div class="grow"></div>
      <button id="btnInstall" class="btn btn-gold">Add to Home Screen</button>
      <span class="muted">Auto-saves locally</span>
    </div>
  </footer>

<script>
(function(){
  const CHECKS = ["Paint","Flooring","Lighting","Plumbing","HVAC","Furniture","Appliances","Windows/Doors","Bathroom","Deep Clean"];
  const STORAGE_KEY = "se_singlefile_v1";
  const state = {
    rooms: [], // {id, status, notes, checklist: {key:boolean}, photos:[{id,name,size,type,url}]}
    deferredPrompt: null,
    query: ""
  };

  const $ = (sel) => document.querySelector(sel);
  const list = $('#list');
  const q = $('#q');
  const stats = $('#stats');
  const bar = $('#bar');
  const importFile = $('#importFile');
  const btnExportAll = document.getElementById('btnExportAll');

  function bytesToSize(bytes){
    if(!bytes) return '0 B';
    const k=1024,s=['B','KB','MB','GB','TB'];
    const i=Math.floor(Math.log(bytes)/Math.log(k));
    return (bytes/Math.pow(k,i)).toFixed(2)+" "+s[i];
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.rooms));
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ state.rooms = JSON.parse(raw); return; }
    }catch{}
    state.rooms = Array.from({length:23}, (_,i)=>({
      id:i+1, status:'todo', notes:'', checklist:Object.fromEntries(CHECKS.map(c=>[c,false])), photos:[]
    }));
  }

  function render(){
    const rooms = state.rooms.filter(r=> String(r.id).includes(state.query) || r.notes.toLowerCase().includes(state.query.toLowerCase()));
    list.innerHTML = '';
    rooms.forEach(room=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-h">
          <div style="font-family:'Playfair Display',serif">Room ${room.id}</div>
          <div class="pill">
            ${['todo','in_progress','done'].map(s=>`<button data-s="${s}" class="${room.status===s?'active':''}">${s==='todo'?'To‚Äëdo':s==='in_progress'?'In progress':'Done'}</button>`).join('')}
          </div>
        </div>
        <details open>
          <summary class="muted">Open details</summary>
          <div class="sec">
            <div class="checks">
              ${CHECKS.map(c=>`<label><input type="checkbox" data-check="${c}"> <span>${c}</span></label>`).join('')}
            </div>
            <div style="margin-top:10px">
              <div class="toolbar">
                <label class="muted">Renovation notes</label>
                <div class="grow"></div>
                <button class="btn btn-gold" data-export-pdf title="Export this room as PDF">Export PDF</button>
              </div>
              <textarea data-notes placeholder="List repairs, measurements, SKUs, suppliers‚Ä¶" style="min-height:90px"></textarea>
              <div class="row" style="margin-top:8px">
                <button class="btn" data-noneneeded>No work needed</button>
                <button class="btn" data-sample>Add sample task</button>
                <div class="grow"></div>
                <label class="btn">üì∑ Use camera <input data-camera type="file" accept="image/*" capture="environment" multiple style="display:none"></label>
                <label class="btn">üñºÔ∏è From gallery <input data-gallery type="file" accept="image/*" multiple style="display:none"></label>
              </div>
            </div>
            <div class="photos" data-photos></div>
            <div class="muted" data-count></div>
          </div>
        </details>
      `;

      // status
      card.querySelectorAll('[data-s]').forEach(btn=>{
        btn.addEventListener('click',()=>{ room.status = btn.getAttribute('data-s'); save(); update(); });
      });

      // checklist
      card.querySelectorAll('[data-check]').forEach(chk=>{
        const key = chk.getAttribute('data-check');
        chk.checked = !!room.checklist[key];
        chk.addEventListener('change',()=>{ room.checklist[key]=chk.checked; save(); updateStats(); });
      });

      // notes
      const notes = card.querySelector('[data-notes]');
      notes.value = room.notes;
      notes.addEventListener('input',()=>{ room.notes = notes.value; save(); updateStats(); });

      // quick buttons
      card.querySelector('[data-noneneeded]').addEventListener('click',()=>{ room.notes = 'No work needed'; notes.value = room.notes; save(); updateStats(); });
      card.querySelector('[data-sample]').addEventListener('click',()=>{ room.notes = (room.notes?room.notes+"
":"") + '‚Ä¢ Replace bulbs with 3000K LED'; notes.value = room.notes; save(); });

      // photos
      const photosWrap = card.querySelector('[data-photos]');
      const countEl = card.querySelector('[data-count]');

      function drawPhotos(){
        photosWrap.innerHTML='';
        room.photos.forEach(p=>{
          const t = document.createElement('div');
          t.className='thumb';
          t.innerHTML = `<img src="${p.url}" alt="${escapeAttr(p.name||'photo')}"><button class="x" title="Remove">‚úï</button>`;
          t.querySelector('.x').addEventListener('click',()=>{ room.photos = room.photos.filter(x=>x.id!==p.id); save(); drawPhotos(); updateStats(); });
          photosWrap.appendChild(t);
        });
        const totalBytes = room.photos.reduce((a,b)=>a+(b.size||0),0);
        countEl.textContent = room.photos.length+" photo(s), total "+bytesToSize(totalBytes);
      }
      drawPhotos();

      async function handleFiles(fileList){
        if(!fileList || !fileList.length) return;
        for(const f of fileList){
          const url = await toDataURL(f);
          room.photos.push({id: room.id+"-"+crypto.randomUUID(), name:f.name, size:f.size, type:f.type, url});
        }
        save(); drawPhotos(); updateStats();
      }
      card.querySelector('[data-camera]').addEventListener('change',e=>handleFiles(e.target.files));
      card.querySelector('[data-gallery]').addEventListener('change',e=>handleFiles(e.target.files));

      // PDF export button
      card.querySelector('[data-export-pdf]').addEventListener('click',()=> exportRoomPDF(room));

      list.appendChild(card);
    });

    updateStats();
  }

  function update(){ render(); }

  function updateStats(){
    const done = state.rooms.filter(r=>r.status==='done').length;
    const photos = state.rooms.reduce((n,r)=>n+r.photos.length,0);
    const shown = document.querySelectorAll('#list .card').length || 0;
    stats.textContent = `${shown} shown ‚Ä¢ ${done}/23 done ‚Ä¢ ${photos} photos`;
    bar.style.width = Math.round((done/23)*100) + '%';
  }

  function exportJSON(){
    const payload = state.rooms;
    const blob = new Blob([JSON.stringify({exportedAt:new Date().toISOString(), rooms:payload}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'sherbrooke-east-rooms-1-23.json'; a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{ const data = JSON.parse(reader.result);
        if(Array.isArray(data.rooms)){ state.rooms = data.rooms; save(); update(); }
      }catch(e){ alert('Invalid JSON'); }
    };
    reader.readAsText(file);
  }

  function toDataURL(file){
    return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  }

  // --- HTML escaping helpers (for both text content and attributes) ---
  function escapeHTML(s){
    return (s||'').replace(/[&<>\"']/g, c=>({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':'&quot;',
      "'":"&#39;"
    }[c]));
  }
  function escapeAttr(s){ return escapeHTML(s).replace(/\n/g,' '); }

  // --- Per-room PDF via hidden iframe (reliable) ---
  function printHTMLWithIframe(html){
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();
    const trigger = ()=>{
      try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ console.warn('Print failed', e); }
      setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch(_){} }, 1000);
    };
    if (doc.readyState === 'complete'){ setTimeout(trigger, 50); }
    else iframe.onload = ()=> setTimeout(trigger, 50);
  }

  function exportRoomPDF(room){
    const html = buildRoomPrintHTML(room);
    printHTMLWithIframe(html);
  }

  function buildRoomPrintHTML(room){
    const now = new Date();
    const checklist = Object.entries(room.checklist||{}).map(([k,v])=>`<li>${v?"‚úÖ":"‚¨ú"} ${escapeHTML(k)}</li>`).join('');
    const photos = (room.photos||[]).map(p=>`<div class="ph"><img src="${p.url}" alt="${escapeAttr(p.name||'photo')}"><div class="cap">${escapeHTML(p.name||'')}</div></div>`).join('');
    return `<!doctype html>
<html><head><meta charset="utf-8"><title>Room ${escapeHTML(String(room.id))} ‚Äî Sherbrooke East</title>
<style>
  @page{ size:A4; margin:16mm }
  body{ font-family: Inter, system-ui, Arial; color:#111; }
  h1{ font-family:'Playfair Display',serif; margin:0 0 4px 0; font-size:24px }
  .muted{ color:#555; font-size:12px; margin-bottom:12px }
  .sec{ margin:14px 0 }
  .box{ border:1px solid #ddd; border-radius:12px; padding:12px }
  ul{ margin:0; padding-left:18px }
  .photos{ display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; }
  .ph{ border:1px solid #ddd; border-radius:8px; overflow:hidden }
  .ph img{ width:100%; height:220px; object-fit:cover; display:block }
  .cap{ font-size:11px; color:#444; padding:4px 6px }
  .tag{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #ddd; }
</style></head>
<body>
  <h1>Room ${escapeHTML(String(room.id))} ‚Äî Sherbrooke East</h1>
  <div class="muted">Exported ${escapeHTML(now.toLocaleString())}</div>

  <div class="sec box"><strong>Status:</strong> <span class="tag">${room.status==='done'?'Done':room.status==='in_progress'?'In progress':'To‚Äëdo'}</span></div>
  <div class="sec box"><strong>Notes</strong><div>${escapeHTML(room.notes||'')}</div></div>
  <div class="sec box"><strong>Checklist</strong><ul>${checklist}</ul></div>
  <div class="sec box"><strong>Photos (${(room.photos||[]).length})</strong><div class="photos">${photos || '<div class="muted">No photos</div>'}</div></div>
</body></html>`;
  }

  // PWA install prompt (optional)
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); state.deferredPrompt=e; });
  $('#btnInstall').addEventListener('click', async ()=>{ if(state.deferredPrompt){ state.deferredPrompt.prompt(); state.deferredPrompt=null; }});

  // events
  q.addEventListener('input', ()=>{ state.query = q.value.trim().toLowerCase(); render(); });
  $('#btnExport').addEventListener('click', exportJSON);
  $('#btnClear').addEventListener('click', ()=>{ if(confirm('Clear all data?')){ localStorage.removeItem(STORAGE_KEY); load(); update(); }});
  $('#btnImport').addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', e=>{ if(e.target.files?.length) importJSON(e.target.files[0]); });
  if (btnExportAll) btnExportAll.addEventListener('click', exportAllRooms);

  // init
  load();
  render();

  // self-tests (console only)
  try{
    console.assert(state.rooms.length===23, '23 rooms seeded');
    const b = (function(x){const k=1024,i=Math.floor(Math.log(x)/Math.log(k));return (x/Math.pow(k,i)).toFixed(2);})(1536);
    console.assert(b.startsWith('1.50'),'bytesToSize math check');
    const sample = buildRoomPrintHTML({id:1,status:'todo',notes:'Test & <danger> "quotes" \'apostrophes\'',checklist:{Paint:true,HVAC:false},photos:[{name:'A&B "photo"',url:'data:image/png;base64,AAAA'}]});
    console.assert(/Room 1/.test(sample) && /Checklist/.test(sample), 'PDF HTML builder basic output');
    console.assert(!/>Test & <danger>/.test(sample), 'notes are escaped');
    console.assert(/A&amp;B/.test(sample) && /&quot;photo&quot;/.test(sample), 'photo name escaped');
    console.assert(typeof exportAllRooms === 'function', 'exportAllRooms exists');
    console.assert(!!btnExportAll, 'Export All button present');
  }catch(e){console.warn('Self-tests failed',e)}

  // --- Batch export (downloads local files) ---
  function exportAllRooms(){
    for(const room of state.rooms){
      const html = buildRoomPrintHTML(room);
      const blob = new Blob([html], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Room-${room.id}.pdf`;
      a.click();
    }
    alert('Batch export started. PDFs are downloading.');
  }
})();
</script>
</body>
</html>
